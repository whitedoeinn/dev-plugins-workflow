name: Tests
# Runs on every push to main/feature branches and PRs to main
# - Unit tests: BATS tests in tests/unit/ (script behavior)
# - Integration tests: Structure validation in tests/integration/ (plugin integrity)

on:
  push:
    branches: [main, feature/*]
  pull_request:
    branches: [main]

jobs:
  # ============================================================================
  # Unit Tests - Run on every push/PR
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install BATS
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats
          sudo /tmp/bats/install.sh /usr/local

      - name: Install BATS libraries
        run: |
          sudo git clone https://github.com/bats-core/bats-support.git /usr/local/lib/bats-support
          sudo git clone https://github.com/bats-core/bats-assert.git /usr/local/lib/bats-assert
          sudo git clone https://github.com/bats-core/bats-file.git /usr/local/lib/bats-file

      - name: Run unit tests
        env:
          BATS_LIB_PATH: /usr/local/lib
        run: |
          bats --recursive tests/unit/

  # ============================================================================
  # Integration Tests - Run on every push/PR
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Run integration tests
        run: |
          chmod +x tests/integration/run-integration.sh
          ./tests/integration/run-integration.sh
