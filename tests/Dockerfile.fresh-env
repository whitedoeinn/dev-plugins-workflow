# Fresh environment image - simulates a new user with minimal tools
# Used for testing installation flows and fresh setups
FROM ubuntu:22.04

# Avoid interactive prompts during package installation
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Install only essential tools (git, curl)
# jq and gh should be installed by wdi doctor
RUN apt-get update && apt-get install -y \
    curl \
    git \
    sudo \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user (simulates typical user setup)
RUN useradd -m -s /bin/bash freshuser && \
    echo "freshuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Set up minimal git config
RUN su - freshuser -c 'git config --global user.name "Fresh User"' && \
    su - freshuser -c 'git config --global user.email "fresh@example.com"' && \
    su - freshuser -c 'git config --global init.defaultBranch main'

# Create directories for local bin and config
RUN mkdir -p /home/freshuser/.local/bin /home/freshuser/.config/wdi && \
    chown -R freshuser:freshuser /home/freshuser

# Add local bin to PATH
ENV PATH="/home/freshuser/.local/bin:${PATH}"

# Create e2e directory for test scenarios
RUN mkdir -p /e2e/scenarios && chown -R freshuser:freshuser /e2e

# Switch to fresh user
USER freshuser
WORKDIR /home/freshuser

# Default command - run the fresh install scenario
CMD ["/e2e/scenarios/fresh-install.sh"]
