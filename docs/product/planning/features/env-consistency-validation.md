# Feature: Environment Consistency Validation

**Status:** Complete
**Issue:** #7
**Type:** New Feature
**Complexity:** Moderate

---

## Problem

When developers move between machines, environment drift causes broken workflows, inconsistent behavior, and subtle bugs. Future non-developer users need guaranteed consistent environments to use "safety scissor" sandboxed workflows.

## Solution

Implement environment consistency validation with:
1. **Baseline definition** - `env-baseline.json` defines "correct" environment
2. **SessionStart validation** - Compare current env against baseline on every session
3. **Auto-remediation** - Fix issues automatically when possible
4. **Hard block** - Prevent work when env can't be auto-fixed
5. **Escalation** - Clear instructions + admin contact for unfixable issues

## Done When

- [x] GitHub issue created (#7)
- [x] `env-baseline.json` template created in plugin root
- [x] `scripts/validate-env.sh` validation script created
- [x] `scripts/check-deps.sh` updated to integrate validation
- [x] Auto-remediation works for: plugins, jq
- [x] Hard block with admin contact for unfixable issues
- [x] `sync-config` skill created for manual re-validation
- [x] Documentation updated (CLAUDE.md, README.md)
- [x] Changelog entry added
- [x] Tests pass

## Implementation Plan

### 1. Create Baseline Template
File: `env-baseline.json`
- Required plugins with min versions
- Required CLI tools with install hints
- Admin contact for escalation

### 2. Create Validation Script
File: `scripts/validate-env.sh`
- Parse baseline JSON
- Check each requirement
- Attempt auto-remediation
- Output structured results (JSON)
- Exit code: 0=ok, 1=auto-fixed, 2=blocked

### 3. Update Dependency Checker
File: `scripts/check-deps.sh`
- Call validate-env.sh
- Handle all three outcomes
- Format user-friendly output

### 4. Create Sync Config Skill
File: `skills/workflow-config-sync/SKILL.md`
- Manual trigger: "check my config", "sync config", "validate environment"
- Runs full validation
- Shows detailed diff output
- Guides remediation

### 5. Update Documentation
- CLAUDE.md: Add env validation section
- README.md: Add troubleshooting for blocked state
- Changelog: Add feature entry

## Auto-Remediation Matrix

| Issue | Can Auto-Fix | Method |
|-------|-------------|--------|
| Plugin missing | Yes | `claude plugin install X` |
| Plugin outdated | Yes | `claude plugin update X` |
| jq missing | Yes | `brew install jq` / `apt install jq` |
| gh not authed | No | Guide to `gh auth login` |
| API key missing | No | Guide to settings |

## User Experience

### Happy Path
```
✓ Environment validated
  Plugins: compound-engineering (2.0.0), wdi (1.0.0)
  Tools: gh, jq, git
```

### Auto-Fix Path
```
⚠ Environment drift detected - fixing...
  ✓ Installed: compound-engineering
  ✓ Updated: wdi (0.9.0 → 1.0.0)
✓ Environment now validated
```

### Blocked Path
```
✗ Environment cannot be auto-fixed

Issues requiring manual action:
  • gh CLI not authenticated
    Run: gh auth login

After fixing, say "check my config" to re-validate.

Admin contact: David Roberts <david@whitedoeinn.com>
```

## Dependencies

**Blocked by:** None

**Enables:** Safety scissor mode (future feature for non-developer users)

---

*Created: 2026-01-12*
*Generated by /wdi:feature*
