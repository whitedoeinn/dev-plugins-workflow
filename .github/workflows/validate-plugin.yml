name: Validate Plugin
# Runs on every push to main
# Validates plugin structure, JSON syntax, and documentation consistency:
# - JSON syntax: plugin.json, marketplace.json, hooks.json must be valid
# - Required files: plugin.json, install.sh, CLAUDE.md must exist
# - Script permissions: install.sh, check-deps.sh must be executable
# - Hook references: Scripts referenced in hooks.json must exist
# - Documentation drift: Commands/skills must be documented in CLAUDE.md and README.md
# - Dependency map: Standards references must be valid

on:
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check JSON syntax
        run: |
          echo "Validating JSON files..."
          for file in .claude-plugin/plugin.json .claude-plugin/marketplace.json hooks/hooks.json; do
            if [ -f "$file" ]; then
              echo "  Checking $file"
              jq empty "$file" || exit 1
            fi
          done
          echo "All JSON files valid"

      - name: Verify plugin structure
        run: |
          echo "Checking required files..."
          required_files=(
            ".claude-plugin/plugin.json"
            "install.sh"
            "CLAUDE.md"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing required file: $file"
              exit 1
            fi
            echo "  ✓ $file"
          done
          echo "Plugin structure valid"

      - name: Check scripts are executable
        run: |
          echo "Checking script permissions..."
          scripts=(
            "install.sh"
            "scripts/check-deps.sh"
          )
          for script in "${scripts[@]}"; do
            if [ -f "$script" ]; then
              if [ ! -x "$script" ]; then
                echo "ERROR: Script not executable: $script"
                exit 1
              fi
              echo "  ✓ $script is executable"
            fi
          done

      - name: Validate hook script references
        run: |
          echo "Checking hook references..."
          if [ -f "hooks/hooks.json" ]; then
            scripts=$(jq -r '.hooks[].command | select(. != null) | split(" ")[0]' hooks/hooks.json 2>/dev/null || true)
            for script in $scripts; do
              if [ ! -f "$script" ]; then
                echo "ERROR: Hook references missing script: $script"
                exit 1
              fi
              echo "  ✓ $script exists"
            done
          fi
          echo "Hook references valid"

      # Ensures every command and skill is documented in both CLAUDE.md and README.md,
      # versions are aligned, and no docs reference deleted files
      - name: Check documentation drift
        run: |
          echo "Checking for documentation drift..."
          chmod +x scripts/check-docs-drift.sh
          if ! ./scripts/check-docs-drift.sh --verbose; then
            echo ""
            echo "ERROR: Documentation drift detected!"
            echo "Run 'update the docs' skill or manually sync CLAUDE.md and README.md"
            exit 1
          fi
          echo "No documentation drift detected"

      - name: Validate dependency map
        run: |
          echo "Validating standards dependency map..."
          chmod +x scripts/validate-dependency-map.sh
          if ! ./scripts/validate-dependency-map.sh; then
            echo ""
            echo "ERROR: Dependency map has issues!"
            echo "Run '/wdi:standards-update --analyze' to identify and fix"
            exit 1
          fi
