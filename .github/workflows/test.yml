name: Tests

on:
  push:
    branches: [main, feature/*]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      run_e2e:
        description: 'Run E2E tests'
        required: false
        default: 'false'
        type: boolean

jobs:
  # ============================================================================
  # Unit Tests - Run on every push/PR
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install BATS
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats
          sudo /tmp/bats/install.sh /usr/local

      - name: Install BATS libraries
        run: |
          sudo git clone https://github.com/bats-core/bats-support.git /usr/local/lib/bats-support
          sudo git clone https://github.com/bats-core/bats-assert.git /usr/local/lib/bats-assert
          sudo git clone https://github.com/bats-core/bats-file.git /usr/local/lib/bats-file

      - name: Run unit tests
        env:
          BATS_LIB_PATH: /usr/local/lib
        run: |
          bats --recursive tests/unit/

  # ============================================================================
  # Integration Tests - Run on every push/PR
  # ============================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Run integration tests
        run: |
          chmod +x tests/integration/run-integration.sh
          ./tests/integration/run-integration.sh

  # ============================================================================
  # E2E Tests - Docker-based (manual trigger or nightly)
  # ============================================================================
  e2e-tests:
    name: E2E Tests (Docker)
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_e2e == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test image
        run: |
          docker build -t wdi-test -f tests/Dockerfile.test .

      - name: Run unit tests in Docker
        run: |
          docker run --rm wdi-test bats --recursive /plugin/tests/unit/

      - name: Run E2E scenarios
        run: |
          docker run --rm wdi-test /plugin/tests/e2e/run-e2e.sh

  # ============================================================================
  # E2E Tests - Fresh Environment
  # ============================================================================
  e2e-fresh-env:
    name: E2E Fresh Environment
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_e2e == 'true'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build fresh environment image
        run: |
          docker build -t wdi-fresh -f tests/Dockerfile.fresh-env .

      - name: Run fresh install scenario
        run: |
          docker run --rm \
            -v $(pwd):/plugin:ro \
            wdi-fresh \
            /plugin/tests/e2e/scenarios/fresh-install.sh

  # ============================================================================
  # Matrix Tests - Different OS versions
  # ============================================================================
  matrix-tests:
    name: Matrix (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: unit-tests
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, ubuntu-22.04, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install BATS (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          git clone https://github.com/bats-core/bats-core.git /tmp/bats
          sudo /tmp/bats/install.sh /usr/local
          sudo git clone https://github.com/bats-core/bats-support.git /usr/local/lib/bats-support
          sudo git clone https://github.com/bats-core/bats-assert.git /usr/local/lib/bats-assert
          sudo git clone https://github.com/bats-core/bats-file.git /usr/local/lib/bats-file

      - name: Install BATS (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install bats-core
          brew tap bats-core/bats-core
          brew install bats-support bats-assert bats-file

      - name: Set BATS_LIB_PATH (Ubuntu)
        if: runner.os == 'Linux'
        run: echo "BATS_LIB_PATH=/usr/local/lib" >> $GITHUB_ENV

      - name: Set BATS_LIB_PATH (macOS)
        if: runner.os == 'macOS'
        run: echo "BATS_LIB_PATH=$(brew --prefix)/lib" >> $GITHUB_ENV

      - name: Run unit tests
        run: |
          bats --recursive tests/unit/

      - name: Run integration tests
        run: |
          chmod +x tests/integration/run-integration.sh
          ./tests/integration/run-integration.sh

  # ============================================================================
  # Nightly E2E (scheduled)
  # ============================================================================
  nightly-e2e:
    name: Nightly E2E
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run full E2E suite
        run: |
          docker compose -f tests/docker-compose.test.yml up --abort-on-container-exit

# Schedule nightly E2E runs
# Uncomment to enable:
# on:
#   schedule:
#     - cron: '0 2 * * *'  # 2 AM UTC daily
